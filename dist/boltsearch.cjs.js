"use strict";function e(e){let t=[];for(let r=0;r<e.length;++r)t[r]=e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().charCodeAt(r);return t}Object.defineProperty(exports,"__esModule",{value:!0});const t=[...[" ","！","？","，","。","、","…"].map((e=>e.charCodeAt(0)))];function r(e,t){const r=e[t];if(void 0!==r)return r;let n=t;Array.isArray(t)||(n=t.split("."));let o=-1;for(;e&&++o<n.length;)e=e[n[o]];return e}function n(e,r){const n=r._codes,o=e.length,c=n.length;let s=0,i=0,l=e[0],u=[],a=0,f=0,h=[],d=0,x=0;for(;l===n[i]?(u[a++]=i,++s,l=e[s]):(++f,t.includes(n[i])&&f>0&&(s=0,l=e[s],u=[],a=0,f=0)),a>0&&(a===d&&f<x&&(h=u,d=a,x=f),a>d&&(h=u,d=a,x=f)),++i,!(i>=c););let p=0;return p+=d/o*80,p+=d?10-x/o:0,p+=d?10-h[0]/(c-1):0,{score:p,text:r.text,indexes:h}}function o(e,t){return e?t?{text:e.text,indexes:e.indexes.concat(t.indexes.filter((t=>e.indexes.indexOf(t)<0))).sort(((e,t)=>e-t))}:e:t}function c(t,o,c){if(!t)return[];const s=e(t),i=function(){var e=[],t=0,r={};function n(){for(var r=0,n=e[r],o=1;o<t;){var c=o+1;r=o,c<t&&e[c].score<e[o].score&&(r=c),e[r-1>>1]=e[r],o=1+(r<<1)}for(var s=r-1>>1;r>0&&n.score<e[s].score;s=(r=s)-1>>1)e[r]=e[s];e[r]=n}return r.add=function(r){var n=t;e[t++]=r;for(var o=n-1>>1;n>0&&r.score<e[o].score;o=(n=o)-1>>1)e[n]=e[o];e[n]=r},r.poll=function(){if(0!==t){var r=e[0];return e[0]=e[--t],n(),r}},r.peek=function(r){if(0!==t)return e[0]},r.replaceTop=function(t){e[0]=t,n()},r}(),l=c.threshold||0,u=c.limit||o.length;let a=0;if(c.key)for(let e=o.length-1;e>=0;--e){const t=r(o[e],c.key);if(!t||!t._codes)continue;let f=n(s,t);if(null===f)continue;if(f.score<l)continue;const h={index:e,score:f.score,match:{text:f.text,indexes:f.indexes}};a<u?(++a,i.add(h)):h.score>i.peek().score&&i.replaceTop(h)}if(c.keys)for(let e=o.length-1;e>=0;--e){const t=o[e];let f=[];for(let e=c.keys.length-1;e>=0;--e){const o=r(t,c.keys[e]);o&&o._codes?f[e]=n(s,o):f[e]=null}const h=c.weights?c.weights.reduce(((e,t)=>e+t),0):c.keys.length,d=f.reduce(((e,t,r)=>null===t?e:c.weights?e+t.score*c.weights[r]/h:e+t.score/h),0);if(null===d)continue;if(d<l)continue;const x={index:e,score:d,matches:f.map((e=>({text:e.text,indexes:e.indexes})))};a<u?(++a,i.add(x)):x.score>i.peek().score&&i.replaceTop(x)}if(0===a)return[];let f=[];for(let e=a-1;e>=0;--e)f[e]=i.poll();return f}exports.highlight=function(e,t,r){if(null===e)return null;if(void 0===e)return null;void 0===t&&(t="<b>"),void 0===r&&(r="</b>");let n="",o=0,c=!1;const s=e.text,i=e.indexes;for(let e=0;e<s.length;++e){const l=s[e].replace(/[&<"']/g,(e=>{switch(e){case"&":return"&amp;";case"<":return"&lt;";case'"':return"&quot;";default:return"&#039;"}}));if(i[o]===e){if(++o,c||(c=!0,n+=t),o===i.length){n+=l+r+s.substr(e+1);break}}else c&&(c=!1,n+=r);n+=l}return n},exports.prepare=function(t){return t?{text:t,_codes:e(t)}:{text:"",_codes:[]}},exports.search=function(e,t,r){let n=e.trim().replace(/\s+/g," ").split(" ");if(1===n.length)return c(n[0],t,r);{n=[...new Set(n)];const e=n.reduce(((e,t)=>e+t.length),0);return function(e,t){let r={};e.forEach((({weight:e,results:t})=>{for(let n=t.length-1;n>=0;--n){const c=t[n],s=c.index,i=r[s];r[s]={index:s,score:i?i.score+c.score*e:c.score*e,...c.match&&{match:i?o(i.match,c.match):c.match},...c.matches&&{matches:i?i.matches.map(((e,t)=>o(e,c.matches[t]))):c.matches}}}}));const n=Object.values(r).sort(((e,t)=>t.score-e.score));return t?n.slice(0,t):n}(n.map((n=>({weight:n.length/e,results:c(n,t,r)}))),r.limit)}};
