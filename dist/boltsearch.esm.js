function e(e){let t=[];for(let n=0;n<e.length;++n)t[n]=e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().charCodeAt(n);return t}function t(t){return t?{text:t,_codes:e(t)}:{text:"",_codes:[]}}const n=[...[" ","！","？","，","。","、","…"].map((e=>e.charCodeAt(0)))];function r(e,t){const n=e[t];if(void 0!==n)return n;let r=t;Array.isArray(t)||(r=t.split("."));let c=-1;for(;e&&++c<r.length;)e=e[r[c]];return e}function c(e,t){const r=t._codes,c=e.length,o=r.length;let s=0,i=0,l=e[0],u=[],a=0,f=0,h=[],d=0,x=0;for(;l===r[i]?(u[a++]=i,++s,l=e[s]):(++f,n.includes(r[i])&&f>0&&(s=0,l=e[s],u=[],a=0,f=0)),a>0&&(a===d&&f<x&&(h=u,d=a,x=f),a>d&&(h=u,d=a,x=f)),++i,!(i>=o););let g=0;return g+=d/c*80,g+=d?10-x/c:0,g+=d?10-h[0]/(o-1):0,{score:g,text:t.text,indexes:h}}function o(e,t){return e?t?{text:e.text,indexes:e.indexes.concat(t.indexes.filter((t=>e.indexes.indexOf(t)<0))).sort(((e,t)=>e-t))}:e:t}function s(t,n,o){if(!t)return[];const s=e(t),i=function(){var e=[],t=0,n={};function r(){for(var n=0,r=e[n],c=1;c<t;){var o=c+1;n=c,o<t&&e[o].score<e[c].score&&(n=o),e[n-1>>1]=e[n],c=1+(n<<1)}for(var s=n-1>>1;n>0&&r.score<e[s].score;s=(n=s)-1>>1)e[n]=e[s];e[n]=r}return n.add=function(n){var r=t;e[t++]=n;for(var c=r-1>>1;r>0&&n.score<e[c].score;c=(r=c)-1>>1)e[r]=e[c];e[r]=n},n.poll=function(){if(0!==t){var n=e[0];return e[0]=e[--t],r(),n}},n.peek=function(n){if(0!==t)return e[0]},n.replaceTop=function(t){e[0]=t,r()},n}(),l=o.threshold||0,u=o.limit||n.length;let a=0;if(o.key)for(let e=n.length-1;e>=0;--e){const t=r(n[e],o.key);if(!t||!t._codes)continue;let f=c(s,t);if(null===f)continue;if(f.score<l)continue;const h={index:e,score:f.score,match:{text:f.text,indexes:f.indexes}};a<u?(++a,i.add(h)):h.score>i.peek().score&&i.replaceTop(h)}if(o.keys)for(let e=n.length-1;e>=0;--e){const t=n[e];let f=[];for(let e=o.keys.length-1;e>=0;--e){const n=r(t,o.keys[e]);n&&n._codes?f[e]=c(s,n):f[e]=null}const h=o.weights?o.weights.reduce(((e,t)=>e+t),0):o.keys.length,d=f.reduce(((e,t,n)=>null===t?e:o.weights?e+t.score*o.weights[n]/h:e+t.score/h),0);if(null===d)continue;if(d<l)continue;const x={index:e,score:d,matches:f.map((e=>({text:e.text,indexes:e.indexes})))};a<u?(++a,i.add(x)):x.score>i.peek().score&&i.replaceTop(x)}if(0===a)return[];let f=[];for(let e=a-1;e>=0;--e)f[e]=i.poll();return f}function i(e,t,n){let r=e.trim().replace(/\s+/g," ").split(" ");if(1===r.length)return s(r[0],t,n);{r=[...new Set(r)];const e=r.reduce(((e,t)=>e+t.length),0);return function(e,t){let n={};e.forEach((({weight:e,results:t})=>{for(let r=t.length-1;r>=0;--r){const c=t[r],s=c.index,i=n[s];n[s]={index:s,score:i?i.score+c.score*e:c.score*e,...c.match&&{match:i?o(i.match,c.match):c.match},...c.matches&&{matches:i?i.matches.map(((e,t)=>o(e,c.matches[t]))):c.matches}}}}));const r=Object.values(n).sort(((e,t)=>t.score-e.score));return t?r.slice(0,t):r}(r.map((r=>({weight:r.length/e,results:s(r,t,n)}))),n.limit)}}function l(e,t,n){if(null===e)return null;if(void 0===e)return null;void 0===t&&(t="<b>"),void 0===n&&(n="</b>");let r="",c=0,o=!1;const s=e.text,i=e.indexes;for(let e=0;e<s.length;++e){const l=s[e].replace(/[&<"']/g,(e=>{switch(e){case"&":return"&amp;";case"<":return"&lt;";case'"':return"&quot;";default:return"&#039;"}}));if(i[c]===e){if(++c,o||(o=!0,r+=t),c===i.length){r+=l+n+s.substr(e+1);break}}else o&&(o=!1,r+=n);r+=l}return r}export{l as highlight,t as prepare,i as search};
