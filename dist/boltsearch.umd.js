!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).boltsearch={})}(this,(function(e){"use strict";function t(e){let t=[];for(let n=0;n<e.length;++n)t[n]=e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().charCodeAt(n);return t}const n=[...[" ","！","？","，","。","、","…"].map((e=>e.charCodeAt(0)))];function r(e,t){const n=e[t];if(void 0!==n)return n;let r=t;Array.isArray(t)||(r=t.split("."));let o=-1;for(;e&&++o<r.length;)e=e[r[o]];return e}function o(e,t){const r=t._codes,o=e.length,c=r.length;let s=0,i=0,l=e[0],u=[],f=0,a=0,d=[],h=0,p=0;for(;l===r[i]?(u[f++]=i,++s,l=e[s]):(++a,n.includes(r[i])&&a>0&&(s=0,l=e[s],u=[],f=0,a=0)),f>0&&(f===h&&a<p&&(d=u,h=f,p=a),f>h&&(d=u,h=f,p=a)),++i,!(i>=c););let x=0;return x+=h/o*80,x+=h?10-p/o:0,x+=h?10-d[0]/(c-1):0,{score:x,text:t.text,indexes:d}}function c(e,t){return e?t?{text:e.text,indexes:e.indexes.concat(t.indexes.filter((t=>e.indexes.indexOf(t)<0))).sort(((e,t)=>e-t))}:e:t}function s(e,n,c){if(!e)return[];const s=t(e),i=function(){var e=[],t=0,n={};function r(){for(var n=0,r=e[n],o=1;o<t;){var c=o+1;n=o,c<t&&e[c].score<e[o].score&&(n=c),e[n-1>>1]=e[n],o=1+(n<<1)}for(var s=n-1>>1;n>0&&r.score<e[s].score;s=(n=s)-1>>1)e[n]=e[s];e[n]=r}return n.add=function(n){var r=t;e[t++]=n;for(var o=r-1>>1;r>0&&n.score<e[o].score;o=(r=o)-1>>1)e[r]=e[o];e[r]=n},n.poll=function(){if(0!==t){var n=e[0];return e[0]=e[--t],r(),n}},n.peek=function(n){if(0!==t)return e[0]},n.replaceTop=function(t){e[0]=t,r()},n}(),l=c.threshold||0,u=c.limit||n.length;let f=0;if(c.key)for(let e=n.length-1;e>=0;--e){const t=r(n[e],c.key);if(!t||!t._codes)continue;let a=o(s,t);if(null===a)continue;if(a.score<l)continue;const d={index:e,score:a.score,match:{text:a.text,indexes:a.indexes}};f<u?(++f,i.add(d)):d.score>i.peek().score&&i.replaceTop(d)}if(c.keys)for(let e=n.length-1;e>=0;--e){const t=n[e];let a=[];for(let e=c.keys.length-1;e>=0;--e){const n=r(t,c.keys[e]);n&&n._codes?a[e]=o(s,n):a[e]=null}const d=c.weights?c.weights.reduce(((e,t)=>e+t),0):c.keys.length,h=a.reduce(((e,t,n)=>null===t?e:c.weights?e+t.score*c.weights[n]/d:e+t.score/d),0);if(null===h)continue;if(h<l)continue;const p={index:e,score:h,matches:a.map((e=>({text:e.text,indexes:e.indexes})))};f<u?(++f,i.add(p)):p.score>i.peek().score&&i.replaceTop(p)}if(0===f)return[];let a=[];for(let e=f-1;e>=0;--e)a[e]=i.poll();return a}e.highlight=function(e,t,n){if(null===e)return null;if(void 0===e)return null;void 0===t&&(t="<b>"),void 0===n&&(n="</b>");let r="",o=0,c=!1;const s=e.text,i=e.indexes;for(let e=0;e<s.length;++e){const l=s[e].replace(/[&<"']/g,(e=>{switch(e){case"&":return"&amp;";case"<":return"&lt;";case'"':return"&quot;";default:return"&#039;"}}));if(i[o]===e){if(++o,c||(c=!0,r+=t),o===i.length){r+=l+n+s.substr(e+1);break}}else c&&(c=!1,r+=n);r+=l}return r},e.prepare=function(e){return e?{text:e,_codes:t(e)}:{text:"",_codes:[]}},e.search=function(e,t,n){let r=e.trim().replace(/\s+/g," ").split(" ");if(1===r.length)return s(r[0],t,n);{r=[...new Set(r)];const e=r.reduce(((e,t)=>e+t.length),0);return function(e,t){let n={};e.forEach((({weight:e,results:t})=>{for(let r=t.length-1;r>=0;--r){const o=t[r],s=o.index,i=n[s];n[s]={index:s,score:i?i.score+o.score*e:o.score*e,...o.match&&{match:i?c(i.match,o.match):o.match},...o.matches&&{matches:i?i.matches.map(((e,t)=>c(e,o.matches[t]))):o.matches}}}}));const r=Object.values(n).sort(((e,t)=>t.score-e.score));return t?r.slice(0,t):r}(r.map((r=>({weight:r.length/e,results:s(r,t,n)}))),n.limit)}},Object.defineProperty(e,"__esModule",{value:!0})}));
